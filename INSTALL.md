# D&D Play-by-Post Installation Guide

This guide will help you install and configure the D&D Play-by-Post application on your own server.

## Prerequisites

### Required
- **Docker** and **Docker Compose** installed
- **Linux server** (Ubuntu 20.04+ recommended) or WSL2 on Windows
- **2GB RAM** minimum (4GB recommended)
- **10GB disk space** minimum

### For Production Deployment
- **Domain name** pointing to your server's IP address
- **Ports 80 and 443** open in your firewall
- **Email address** for SSL certificate notifications

## Quick Start (Development)

For local development without SSL:

```bash
# 1. Clone the repository
git clone <repository-url>
cd dndplaybypost

# 2. Run the setup script
./setup.sh
# When prompted, enter 'localhost' as the domain

# 3. Start the application
docker-compose up -d

# 4. Access the application
# Open http://localhost in your browser

# 5. Register the first user (will be admin)
# Go to http://localhost/register
```

## Production Installation

### Step 1: Server Preparation

```bash
# Update system packages
sudo apt update && sudo apt upgrade -y

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# Install Docker Compose
sudo apt install docker-compose-plugin -y

# Add your user to docker group (optional)
sudo usermod -aG docker $USER
# Log out and back in for this to take effect
```

### Step 2: DNS Configuration

Before proceeding, ensure your domain points to your server:

```bash
# Verify DNS is configured
dig +short yourdomain.com
# Should return your server's IP address
```

### Step 3: Firewall Configuration

```bash
# Allow HTTP and HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp  # SSH (if not already allowed)
sudo ufw enable
```

### Step 4: Clone and Setup

```bash
# Clone the repository
git clone <repository-url>
cd dndplaybypost

# Run the interactive setup script
./setup.sh
```

The setup script will prompt you for:
- **Domain name**: Enter your domain (e.g., `dnd.example.com`)
- **Email address**: For SSL certificate notifications
- **DNS confirmation**: Confirm your DNS is configured

The script will:
- ✅ Generate secure random secrets
- ✅ Create `.env` configuration file
- ✅ Obtain SSL certificate from Let's Encrypt
- ✅ Configure nginx for HTTPS

### Step 5: Start the Application

```bash
# Start all services
docker-compose up -d

# Check status
docker-compose ps

# View logs
docker-compose logs -f
```

### Step 6: Create Admin User

1. Navigate to `https://yourdomain.com/register`
2. Register the first user (will automatically be admin)
3. Log in with your credentials

## Configuration

### Environment Variables

The `.env` file contains all configuration. Key variables:

```bash
# Domain and SSL
DOMAIN=yourdomain.com
ENABLE_SSL=true
SSL_EMAIL=admin@example.com

# Security (auto-generated by setup.sh)
SECRET_KEY=<random-secret>
POSTGRES_PASSWORD=<random-password>
REDIS_PASSWORD=<random-password>

# CORS
CORS_ORIGINS=https://yourdomain.com
```

### Nginx Configuration

The `nginx.conf` file handles:
- HTTP to HTTPS redirect
- SSL/TLS termination
- Reverse proxy to backend and frontend
- Rate limiting
- Security headers

For development (localhost), the HTTPS server block is disabled by default.

## SSL Certificate Management

### Automatic Renewal

Certbot automatically renews certificates every 12 hours. No manual intervention needed.

### Manual Renewal

```bash
# Test renewal (dry run)
docker-compose run --rm certbot renew --dry-run

# Force renewal
docker-compose run --rm certbot renew --force-renewal

# Restart nginx after manual renewal
docker-compose restart nginx
```

### Using Self-Signed Certificates

For development or private networks:

```bash
# Generate self-signed certificate
mkdir -p nginx/ssl
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout nginx/ssl/key.pem \
  -out nginx/ssl/cert.pem \
  -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"

# Update nginx.conf to use self-signed certs
# (See comments in nginx.conf)
```

## Maintenance

### Viewing Logs

```bash
# All services
docker-compose logs -f

# Specific service
docker-compose logs -f backend
docker-compose logs -f frontend
docker-compose logs -f nginx
```

### Updating the Application

```bash
# Pull latest changes
git pull

# Rebuild and restart
docker-compose down
docker-compose up --build -d
```

### Database Backup

```bash
# Backup database
docker-compose exec postgres pg_dump -U dnd dnd_pbp > backup.sql

# Restore database
docker-compose exec -T postgres psql -U dnd dnd_pbp < backup.sql
```

### Stopping the Application

```bash
# Stop all services
docker-compose down

# Stop and remove volumes (WARNING: deletes data)
docker-compose down -v
```

## Troubleshooting

### SSL Certificate Issues

**Problem**: Certificate not obtained

```bash
# Check DNS is correct
dig +short yourdomain.com

# Check ports are open
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# Try obtaining certificate manually
docker-compose run --rm certbot certonly \
  --webroot -w /var/www/certbot \
  -d yourdomain.com \
  --email your@email.com
```

**Problem**: Certificate expired

```bash
# Force renewal
docker-compose run --rm certbot renew --force-renewal
docker-compose restart nginx
```

### Connection Issues

**Problem**: Can't connect to application

```bash
# Check all services are running
docker-compose ps

# Check nginx logs
docker-compose logs nginx

# Verify ports are accessible
curl -I http://localhost
curl -I https://localhost
```

**Problem**: 502 Bad Gateway

```bash
# Check backend is running
docker-compose logs backend

# Restart services
docker-compose restart backend frontend nginx
```

### Database Issues

**Problem**: Database connection failed

```bash
# Check postgres is running
docker-compose logs postgres

# Verify credentials in .env
cat .env | grep POSTGRES

# Restart database
docker-compose restart postgres
```

## Security Recommendations

### Production Checklist

- [ ] Use a strong, unique `SECRET_KEY`
- [ ] Use strong database passwords
- [ ] Enable SSL/HTTPS
- [ ] Configure firewall (only ports 80, 443, 22 open)
- [ ] Regular backups
- [ ] Keep Docker images updated
- [ ] Monitor logs for suspicious activity
- [ ] Use a reverse proxy (nginx already configured)
- [ ] Enable fail2ban for SSH protection

### Regular Maintenance

```bash
# Update Docker images monthly
docker-compose pull
docker-compose up -d

# Check for security updates
sudo apt update && sudo apt upgrade -y

# Review logs weekly
docker-compose logs --since 7d | grep -i error
```

## Support

For issues or questions:
1. Check the [Troubleshooting](#troubleshooting) section
2. Review logs: `docker-compose logs`
3. Check GitHub issues
4. Create a new issue with logs and configuration (remove secrets!)

## Next Steps

After installation:
1. ✅ Register admin user
2. ✅ Configure email settings (optional)
3. ✅ Create your first campaign
4. ✅ Invite players
5. ✅ Start playing!
